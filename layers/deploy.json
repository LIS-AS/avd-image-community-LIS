{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "resources": [
        {
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "/subscriptions/b0604914-cd2c-4ac9-91bf-c25b32fd0892/resourceGroups/rg-tueschoolyear-imagebuilding-prd-002/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-tueschoolyear-imagebuilder-prd-002": {}
                }
            },
            "location": "germanywestcentral",
            "name": "python-2025-10-22_11-45-30",
            "properties": {
                "autoRun": {
                    "state": "Enabled"
                },
                "buildTimeoutInMinutes": 180,
                "customize": [
                    {
                        "inline": [
                            "Write-Host \"Setting error action to 'stop'\"",
                            "$ErrorActionPreference = \"Stop\"",
                            "Write-Host \"Set progressPreference to 'silentlyContinue'\"",
                            "$ProgressPreference = \"SilentlyContinue\"",
                            "Write-Host \"Fetching access token for managed identity\"",
                            "$maxRetries = 3",
                            "$retryCount = 0",
                            "while ($retryCount -lt $maxRetries) {",
                            "\t$retryCount++",
                            "\ttry {",
                            "\t\t$response = Invoke-RestMethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01\u0026resource=https%3A%2F%2Fstorage.azure.com%2F\u0026mi_res_id=%2Fsubscriptions%2Fb0604914-cd2c-4ac9-91bf-c25b32fd0892%2FresourceGroups%2Frg-tueschoolyear-imagebuilding-prd-002%2Fproviders%2FMicrosoft.ManagedIdentity%2FuserAssignedIdentities%2Fid-tueschoolyear-imagebuilder-prd-002' -Headers @{Metadata=\"true\"}",
                            "\t\tbreak",
                            "\t} catch {",
                            "\t\tif ($retryCount -ge $maxRetries) { Write-Error \"Failed to request data from metadata endpoint (after $maxRetries attempts): $_\" }",
                            "\t\tStart-Sleep 30",
                            "\t}",
                            "}",
                            "$accessToken = $response.access_token",
                            "$headers = @{'Authorization' = \"Bearer $accessToken\"; 'x-ms-version' = \"2020-04-08\"}",
                            "Write-Host \"Downloading bundle, from: https://stschoolyearimageres002.blob.core.windows.net/cr-tueschoolyear-prd-002/bundle-2d13634c6042684fe7cf96b198a321870abf77917326ed5333646a8636e89aa3.zip to: C:\\image_bundle.zip\"",
                            "$retryCount = 0",
                            "while ($retryCount -lt $maxRetries) {",
                            "\t$retryCount++",
                            "\ttry {",
                            "\t\tInvoke-WebRequest -Uri 'https://stschoolyearimageres002.blob.core.windows.net/cr-tueschoolyear-prd-002/bundle-2d13634c6042684fe7cf96b198a321870abf77917326ed5333646a8636e89aa3.zip' -Headers $headers -OutFile 'C:\\image_bundle.zip'",
                            "\t\tbreak",
                            "\t} catch {",
                            "\t\tif ($retryCount -ge $maxRetries) { Write-Error \"An error occured during bundle download (after $maxRetries attempts): $_\" }",
                            "\t\tStart-Sleep 30",
                            "\t}",
                            "}",
                            "Write-Host \"Extracting bundle archive\"",
                            "Expand-Archive -LiteralPath 'C:\\image_bundle.zip' -DestinationPath 'C:\\image_bundle'"
                        ],
                        "name": "BundleExtraction",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "inline": [
                            "Write-Host \"Set error action to 'stop'\"",
                            "$ErrorActionPreference = \"Stop\"",
                            "Write-Host \"Set progressPreference to silentlyContinue\"",
                            "$ProgressPreference = \"SilentlyContinue\"",
                            "Write-Host \"Entering the bundle directory\"",
                            "Push-Location \"C:\\image_bundle\"",
                            "Write-Host \"Executing bundle\"",
                            "\u0026 \"./execute.ps1\" -ScanForDirectories -Force",
                            "if (!$?) {Write-Error \"The bundle execution failed\"; exit 5}",
                            "Write-Host Exiting the bundle directory",
                            "Pop-Location"
                        ],
                        "name": "BundleExecution",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    },
                    {
                        "name": "PostBundleExecutionRestart",
                        "type": "WindowsRestart"
                    },
                    {
                        "inline": [
                            "Write-Host \"Removing bundle directory and archive\"",
                            "Remove-Item -Path \"C:\\image_bundle.zip\", \"C:\\image_bundle\" -Recurse",
                            "Write-Host \"Adjusting deprovisioning script\"",
                            "((Get-Content -path C:\\\\DeprovisioningScript.ps1 -Raw) -replace 'Sysprep.exe /oobe /generalize /quiet /quit','Sysprep.exe /oobe /generalize /quit /mode:vm' ) | Set-Content -Path C:\\\\DeprovisioningScript.ps1",
                            "Write-Host \"Ready for sysprep\""
                        ],
                        "name": "BundleCleanup",
                        "runAsSystem": true,
                        "runElevated": true,
                        "type": "PowerShell"
                    }
                ],
                "distribute": [
                    {
                        "artifactTags": {
                            "SY_BUNDLE_URL": "https://stschoolyearimageres002.blob.core.windows.net/cr-tueschoolyear-prd-002/bundle-python-2025-10-22_11-45-04.json"
                        },
                        "excludeFromLatest": false,
                        "galleryImageId": "/subscriptions/b0604914-cd2c-4ac9-91bf-c25b32fd0892/resourceGroups/rg-tueschoolyear-imagebuilding-prd-002/providers/Microsoft.Compute/galleries/igtueschoolyearprd002/images/python",
                        "runOutputName": "gallery",
                        "targetRegions": [
                            {
                                "name": "germanywestcentral",
                                "replicaCount": 5
                            }
                        ],
                        "type": "SharedImage"
                    }
                ],
                "optimize": {
                    "vmBoot": {
                        "state": "Disabled"
                    }
                },
                "source": {
                    "offer": "windows-10",
                    "publisher": "microsoftwindowsdesktop",
                    "sku": "win10-22h2-avd-g2",
                    "type": "PlatformImage",
                    "version": "latest"
                },
                "vmProfile": {
                    "osDiskSizeGB": 127,
                    "userAssignedIdentities": [
                        "/subscriptions/b0604914-cd2c-4ac9-91bf-c25b32fd0892/resourceGroups/rg-tueschoolyear-imagebuilding-prd-002/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-tueschoolyear-imagebuilder-prd-002"
                    ],
                    "vmSize": "Standard_D2s_v4"
                }
            },
            "tags": {
                "AVD_IMAGE_TEMPLATE": "AVD_IMAGE_TEMPLATE"
            },
            "type": "Microsoft.VirtualMachineImages/imageTemplates",
            "apiVersion": "2024-02-01"
        }
    ]
}